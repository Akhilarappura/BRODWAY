<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BRODWAY</title>

  <!-- 
    - favicon
  -->
  <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">

  <!-- 
    - custom css link
  -->
<link rel="stylesheet" href="/public/css/style.css">
  <link rel="stylesheet" href="/public/css/newIndex.css">

  <!-- 
    - google font link
  -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;500;600;700&family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet">

  <!-- 
    - preload banner
  -->
  <link rel="preload" href="/footwear-master/public/imgee/hero-banner.png" as="image">

</head>
<style>
  .filter-products-wrapper {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
  }

  .filter-section {
    flex: 0 0 200px;
    /* Adjust the width as needed */
    margin-right: 10px;
    /* Adjust spacing between the filter and product sections */
  }

  .productsContainer {
    flex: 1;
    /* Takes up the remaining space */
    display: flex;
    flex-wrap: wrap;
  }

  .productsContainer .col-lg-2,
  .productsContainer .col-md-6,
  .productsContainer .col-sm-4 {
    flex: 0 1 calc(25% - 20px);
    /* Adjust based on breakpoints and spacing */
    margin: 10px;
    /* Adjust spacing between products */
  }

  .pro-img img {
    max-width: 80%;
    height: auto;
  }

  .card-body {
    text-align: center;
  }

  .btn-add-cart a {
    color: white;
  }

  .out-of-stock-message {
    color: red;
    font-weight: bold;
    padding: 10px;
  }

  .original-price {
    color: gray;
    text-decoration: line-through;
    margin-right: 5px;
  }

  .offer-price {
    color: red;
    font-weight: bold;
  }

  .discount-percentage {
    color: green;
    font-weight: bold;
    margin-left: 5px;
  }

  .price {
    font-weight: bold;
  }
</style>

<body id="top">

  <!-- 
    - #HEADER
  -->

  <header class="header" data-header>
    <div class="container">

      <div class="overlay" data-overlay></div>

      <h1>BRODWAY</h1>

      <button class="nav-open-btn" data-nav-open-btn aria-label="Open Menu">
        <ion-icon name="menu-outline"></ion-icon>
      </button>

      <nav class="navbar" data-navbar>

        <button class="nav-close-btn" data-nav-close-btn aria-label="Close Menu">
          <ion-icon name="close-outline"></ion-icon>
        </button>

        <a href="#" class="logo">
          <img src="./assets/images/logo.svg" width="190" height="50" alt="Footcap logo">
        </a>

        <ul class="navbar-list">

          <li class="navbar-item">
            <a href="/" class="navbar-link">Home</a>
          </li>

          <li class="navbar-item">
            <%Category?.forEach(category=>{%>
              <a href="/productCategory?id=<%=category._id%>" class="navbar-link">
                <span>
                  <%=category.categoryName%>
                </span></a>
          </li>
          <%})%>

            <li class="navbar-item">
              <a href="/about" class="navbar-link">About</a>
            </li>
            <li class="navbar-item">
              <a href="/contact" class="navbar-link">Contact</a>
            </li>



        </ul>

        <ul class="nav-action-list">

          <li>
            <button class="nav-action-btn">
              <ion-icon name="search-outline" aria-hidden="true"></ion-icon>

              <span class="nav-action-text">Search</span>
            </button>
          </li>


          <% if (!userToken) { %>
            <li>
              <a href="/login" class="nav-action-btn">
                <ion-icon name="person-outline" aria-hidden="true"></ion-icon>

                <span class="nav-action-text">Login </span>
              </a>
            </li>
            <% } %>

              <% if (userToken) { %>
                <li>
                  <a href="/profile" class="nav-action-btn">
                    <ion-icon name="person-outline" aria-hidden="true"></ion-icon>

                    <span class="nav-action-text">Login </span>
                  </a>
                </li>
                <% } %>
                  <li>
                    <a href="/wishlist" class="nav-action-btn">
                      <ion-icon name="heart-outline" aria-hidden="true"></ion-icon>
                      <span class="nav-action-text">Wishlist</span>
                    </a>
                  </li>
                  <% if (userToken) { %>
                    <li>
                      <a href="/cart" class="nav-action-btn">
                        <ion-icon name="cart-outline" aria-hidden="true"></ion-icon>
                        <span class="nav-action-text">cart</span>
                        <data class="nav-action-badge" value="" aria-hidden="true">
                        
                        </data>
                      </a>
                    </li>
                    <% } %>
                      <% if (!userToken) { %>
                        <li>
                          <a href="/login" class="nav-action-btn">
                            <ion-icon name="cart-outline" aria-hidden="true"></ion-icon>

                            <span class="nav-action-text">Login </span>
                          </a>
                        </li>
                        <% } %>





        </ul>

      </nav>

    </div>
  </header>






<!--  -->
		<!-- <div class="breadcrumbs">
			<div class="container">
				<div class="row">
					<div class="col">
						<p class="bread"><span><a href="/">Home</a></span> / <span>Checkout</span></p>
					</div>
				</div>
			</div>
		</div> -->


		<div class="colorlib-product">
			<div class="container">
				<div class="row row-pb-lg">
					<div class="col-sm-10 offset-md-1">
						<div class="process-wrap">
							<div class="process text-center active">
								<p><span>01</span></p>
								<h3>Shopping Cart</h3>
							</div>
							<div class="process text-center active">
								<p><span>02</span></p>
								<h3>Checkout</h3>
							</div>
							<div class="process text-center">
								<p><span>03</span></p>
								<h3>Order Complete</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Button trigger modal -->
				<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalCenter">
					Add address
				</button>

				<!-- Modal -->
				<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
					aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form action="/checkoutaddress" method="post">
									<fieldset>
										<!-- Address form -->
										<h2>Address</h2>
										<!-- full-name input-->
										<div class="control-group">
											<label class="control-label">Full Name</label>
											<div class="controls">
												<input id="full-name" name="name" type="text" placeholder="full name"
													class="input-xlarge">
												<p class="help-block"></p>
											</div>
										</div>
										<!-- address-line1 input-->
										<div class="control-group">
											<label class="control-label">Address </label>
											<div class="controls">
												<input id="address-line1" name="address" type="text"
													placeholder="address line 1" class="input-xlarge" required>
												<p class="help-block">Street address, P.O. box, company name, c/o</p>
											</div>
										</div>
										<!-- address-line2 input-->
										<div class="control-group">
											<label class="control-label">Mobile No:</label>
											<div class="controls">
												<input id="mobileNo" name="mobileNumber" type="number"
													placeholder="mobile number " class="input-xlarge">
												<p class="help-block">Apartment, suite, unit, building, floor, etc.</p>
											</div>
										</div>
										<!-- city input-->
										<div class="control-group">
											<label class="control-label">District</label>
											<div class="controls">
												<input id="city" name="district" type="text" placeholder="district"
													class="input-xlarge">
												<p class="help-block"></p>
											</div>
										</div>
										<!-- region input-->
										<div class="control-group">
											<label class="control-label">Locality</label>
											<div class="controls">
												<input id="region" name="locality" type="text"
													placeholder="state / province / region" class="input-xlarge">
												<p class="help-block"></p>
											</div>
										</div>
										<!-- postal-code input-->
										<div class="control-group">
											<label class="control-label">Pincode</label>
											<div class="controls">
												<input id="postal-code" name="pincode" type="text"
													placeholder="zip or postal code" class="input-xlarge">
												<p class="help-block"></p>
											</div>
										</div>
										<div class="control-group">
											<label class="control-label">State</label>
											<div class="controls">
												<input id="State-code" name="state" type="text" placeholder="State"
													class="input-xlarge">
												<p class="help-block"></p>
											</div>
										</div>
										<!-- country select -->
										<div class="control-group">
											<label class="control-label">Country</label>
											<div class="controls">
												<select id="country" name="country" class="input-xlarge">
													<option value="" selected="selected">(please select a country)
													</option>
													<option value="AF">India</option>
													<option value="AL"></option>
													<option value="DZ"></option>
												</select>
											</div>
										</div>
									</fieldset>

							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
								<button type="submit" class="btn btn-primary">Save changes</button>
							</div>
							</form>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-lg-8">
						<form method="post" class="colorlib-form">
							<h2>Billing Details</h2>
							<div class="row">
								<div class="col-md-12">
									<div class="form-group">
										<label for="country">Select Country</label>
										<div class="form-field">
											<i class="icon icon-arrow-down3"></i>
											<select name="people" id="people" class="form-control">
												<option value="#">Select country</option>
												<option value="#">India</option>
												<option value="#"></option>
												<option value="#"></option>
												<option value="#"></option>
												<option value="#"></option>
											</select>
										</div>
									</div>
								</div>

								<div class="col-md-6">
									<div class="form-group">
										<label for="fname"> Name</label>
										<!-- <input type="text" id="fname" class="form-control" placeholder="Your firstname"> -->
										<p class="text-muted mb-0">
											<%=detail.name%>
										</p>
									</div>
								</div>


								<div class="col-md-12">
									<div class="form-group">
										<label for="companyname">Email</label>

									</div>
								</div>
								<div class="col-md-12">
									<div class="form-group">
										<label for="address">Select Address</label>

										<select id="address" name="address" class="form-control custom-select">
											<% address.forEach(addr=> { %>
												<option value="<%= addr._id %>">
													<%= addr.name %>, <%= addr.mobileNumber %>, <%= addr.district %>,
																<%= addr.locality %>, <%= addr.pincode %>
												</option>
												<% }); %>
										</select>
									</div>
								</div>

								<div class="col-md-12">
									<div class="form-group">
										<div class="radio">
											<!-- <label><input type="radio" name="optradio"> Create an Account? </label> -->
											<label><input type="radio" name="optradio"> Ship to different address
											</label>
										</div>
									</div>
								</div>

							</div>
						</form>
						<!-- <div class="coupon-section col-md-12">
							<div class="form-group">
								<label for="apply-coupon-code">
									<h2>Apply Coupon Code</h2>
								</label>
								<input type="text" id="apply-coupon-code" name="apply_coupon_code" class="form-control"
									placeholder="Enter coupon code">
							</div>
						</div> -->
						<div class="col-md-12">
							<div class="coupon-section">
								<div class="form-group">
									<label for="available-coupon-code">
										<h2>Available Coupon Code</h2>
									</label><br>
									<button class="btn btn-warning apply-button" data-toggle="modal"
										data-target="#couponModal">Click
										here</button>
								</div>
							</div>
						</div>


					</div>
					<div class="col-lg-4">
						<div class="row">
							<div class="col-md-12">
								<div class="cart-detail">
									<h2>Cart Total</h2>
									<ul id="orderItems">
										<li>
											<input hidden id="allItems" value="<%= total %>" type="text">
											<span>Subtotal : </span> <span>&#8377; <%= total?.totalAmount %></span>
											<ul>
												<% total?.items.forEach(item=>{%>
													<!-- <li><%= item.productId._id %></li> -->
													<li><span>
															<%=item.quantity%> x <%=item.productId.product_name%>
																	<div style="color: red;"
																		id="<%= item.productId._id%>"></div>
														</span> <span>
															<%=item.productId.price%>
														</span></li>
													<li class="item" data-product-id="<%= item.productId._id %>"
														data-quantity="<%= item.quantity %>">

														<% }) %>
											</ul>
										</li>
										<li><span>Shipping</span> <span>&#8377; 0.00</span></li>
										<li><span>Delivery Charge&#8377; 0.00</span></li>
										<li><span>Order Total : &#8377; <span id="totalamountid">
													<%=total?.totalAmount%>
												</span></span></li>
										<input type="text" value="<%=total?.totalAmount%>" hidden id="totalAmountid">

									</ul>
								</div>
							</div>

							<div class="w-100"></div>

							<div class="col-md-12">
								<div class="cart-detail">
									<h2>Payment Method</h2>
									<div class="form-group">
										<div class="col-md-12">
											<div class="radio">
												<label style="display: flex;"><input type="radio" name="optradio" value="netBanking" style="width: 20px;"> <h4>Direct
													Bank Tranfer</h4></label>
											</div>
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-12">
											<div class="radio">
												<label style="display: flex;"><input type="radio" name="optradio" value="checkPayment" style="width: 20px;" > <h4>Check
													Payment</h4></label>
											</div>
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-12">
											<div class="radio">
												<label style="display: flex;" ><input type="radio"  name="optradio" value="cod" style="width: 20px;"><h4> Cash on
													Delivery</h4></label>
													<span id="codeAvailability" style="color: rgb(227, 38, 17);"></span>
											</div>
										</div>
									</div>
									<!-- <div class="form-group">
										<div class="col-md-12">
											<div class="checkbox">
												<label><input type="checkbox" value=""> I have read and accept the terms
													and conditions</label>
											</div>
										</div>
									</div> -->
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-12 text-center">
								<button class="btn-btn-orange" id="placeOrder" style="border-radius: 30px;
								width: 154px;
								background-color: rgb(79, 189, 0);
								color: aliceblue;
								height: 54px;"> place an order</button>
								<div id="errorMessage"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Modal -->
		<div class="modal fade" id="couponModal" tabindex="-1" role="dialog" aria-labelledby="couponModalLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<% if (applicableCoupons && applicableCoupons.length> 0) { %>
							<h2>Available Coupons</h2>
							<ul>
								<% applicableCoupons.forEach((coupon, index)=> { %>

									<li>

										<input type="radio" name="couponS" id="coupon_<%= index%>"
											value="<%=coupon.couponcode%>">
										<input type="text" value="<%=coupon?.couponcode%>" hidden id="couponId">
										<label for="coupon_<%= index %>">
											<b>Code:</b>
											<%= coupon.couponcode %> (Expires: <%=
													coupon.expireDate.toLocaleDateString() %>)<br>
													<b>discountPercentage:</b>
													<%= coupon.discountPercentage %>
										</label>
									</li>
									<% }); %>
							</ul>
							<% } else { %>
								<p>No applicable coupons found.</p>
								<% } %>
									<input type="hidden" id="isCouponApplied" value="false">

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-info" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-warning" id="applySelectedCoupon">Apply Selected
							Coupon</button>
					</div>
				</div>
			</div>
		</div>


	</div>
	</div>
	</div>

	</div>


	</div>
	</div>
	</div>



	

	<script>

		document.getElementById("placeOrder").addEventListener("click", () => {
			const items = [];
			document.querySelectorAll('#orderItems .item').forEach(item => {
				const productId = item.dataset.productId;
				const quantity = item.dataset.quantity;
				items.push({ productId, quantity });
			});



			const selectedAddress = document.getElementById("address").value;
			console.log('selectedAddress', selectedAddress);
			if (!selectedAddress) {
				document.getElementById('errorMessage').innerHTML = 'Please Add the Address'
				return
			}
			const paymentMethod1 = document.querySelector('input[name="optradio"]:checked');

			const paymentMethod = paymentMethod1.value
			

			fetch("/verifyStock", {
				method: "POST",
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ allItems: items })
			})
				.then(response => response.json())
				.then(res => {

					res.outOfStockItems.forEach(item => {

						document.getElementById(item).innerHTML = 'Out of stock'
					})
					// res.outOfStockItems === 0 
					// send the checkout product data to another api end point to save order and decress the stock
					if (res.outOfStockItems.length === 0) {
						console.log('res22222', res.outOfStockItems.length);



						const data = {
							items: items,
							addressId: selectedAddress
						}


						if (paymentMethod === 'cod' && items.length != 0) {
							const codeAvailability=document.getElementById('codeAvailability')
							console.log('2020', items.length)
							console.log("payment", paymentMethod);
							fetch("/stockresult", {
								method: 'post',
								headers: {
									'content-Type': 'application/json'
								},
								body: JSON.stringify({ data, paymentMethod })
							})
								.then(res => res.json())
								.then(response => {
									console.log("hi1111");
									if (res.status === 401) {
										console.log("hi");
										toastr.error('Please add the Address to checkout');
									}
									console.log("response from backend:", data);
									if (response.message === 'order completed') {
										window.location.href = '/thankyou'
									}else if(response.message==='Cod not Available'){
									document.getElementById('codeAvailability').innerHTML="COD NOT AVAILABLE"
									


									}
								})

						}
						console.log('im in1');
						if (paymentMethod === 'netBanking' && items.length !== 0) {
							console.log("in in 2");
							const totalAmount = document.getElementById('totalAmountid').value;
							console.log(totalAmount, "totalAmount");

							fetch('/razorpayment', {
								method: 'post',
								headers: {
									'content-Type': 'application/json'
								},
								body: JSON.stringify({ totalAmount })
							})
								.then(res => res.json())
								.then(res => {
									console.log("data", res);

									const options = {
										"key": "rzp_test_Yf4QX1fH3V3BDE", // Enter the Key ID generated from the Dashboard
										"amount": res.order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
										"currency": "INR",
										"name": 'BRODWAY', //your business name
										"description": "Test Transaction",
										"image": "",
										"order_id": res.order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
										"callback_url": `/onlinepayment?paymentMethod=${paymentMethod}&data=${JSON.stringify(data)}`,
										"prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information especially their phone number
											// "name": "Gaurav Kumar", //your customer's name
											// "email": "",
											// "contact": "" //Provide the customer's phone number for better conversion rates 
										},
										"notes": {
											"address": "Razorpay Corporate Office"
										},
										"theme": {
											"color": "#3399cc"
										}
									};
									const rzp1 = new Razorpay(options);
									rzp1.open();
								})
								.catch(error => {
									console.error("Error in Razorpay payment:", error);
								});
						}
					}
				})
				.catch(error => {
					console.error("Error verifying stock:", error);
				});
		});


	</script>

	<button id="rzp-button1">Pay</button>
	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

	<script>

		document.addEventListener("DOMContentLoaded", function () {
			const applyButton = document.getElementById("applySelectedCoupon");
			const isCouponApplied = document.getElementById("isCouponApplied");

			applyButton.addEventListener("click", function () {
				console.log('isCouponApplied',isCouponApplied.value);
			if(isCouponApplied.value==='false'){
				const selectedCoupon = document.querySelector('input[name="couponS"]:checked');
				const totalAmount = document.getElementById('totalAmountid').value;

				console.log(selectedCoupon);
				const userEmail = '<%= detail.email %>';
				if (selectedCoupon) {
					const couponCode = selectedCoupon.value;
					console.log(`Applying coupon: ${couponCode}`);

					// Send request to apply the selected coupon
					fetch(`/applyCoupon`, {
						method: "POST",
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ couponCode, userEmail, totalAmount })
					})
						.then(response => response.json())
						.then(data => {
							if (data.newTotalAmount !== undefined) {
								Swal.fire({
									title: "Success!",
									text: `Coupon has been applied. You saved ₹${data.discount}.`,
									icon: "success",
								}).then(() => {
                                      document.getElementById('isCouponApplied').value='true';
									// Update the total amount on the page
									document.getElementById("totalAmountid").value = data.newTotalAmount;
									document.getElementById("totalamountid").innerHTML = data.newTotalAmount;
									document.querySelector("span#totalAmountDisplay").innerText = `₹ ${data.newTotalAmount}`;
									

								});
							} else {
								Swal.fire({
									title: "Failed!",
									text: data.message || "Failed to apply coupon.",
									icon: "error",
								});
							}
						})
						.catch(error => {
							console.error("Error:", error);
							Swal.fire({
								title: "Error!",
								text: "An error occurred while applying the coupon.",
								icon: "error",
							});
						});
				} else {
					Swal.fire({
						title: "Warning!",
						text: "Please select a coupon to apply.",
						icon: "warning",
					});
				}
			} else {
					Swal.fire({
						title: "Warning!",
						text: "Already Applied!",
						icon: "warning",
					});
				}
			
			});
		
		});



	</script>

	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


	<!-- jQuery -->
	<script src="js/jquery.min.js"></script>
	<!-- popper -->
	<script src="js/popper.min.js"></script>
	<!-- bootstrap 4.1 -->
	<script src="js/bootstrap.min.js"></script>
	<!-- jQuery easing -->
	<script src="js/jquery.easing.1.3.js"></script>
	<!-- Waypoints -->
	<script src="js/jquery.waypoints.min.js"></script>
	<!-- Flexslider -->
	<script src="js/jquery.flexslider-min.js"></script>
	<!-- Owl carousel -->
	<script src="js/owl.carousel.min.js"></script>
	<!-- Magnific Popup -->
	<script src="js/jquery.magnific-popup.min.js"></script>
	<script src="js/magnific-popup-options.js"></script>
	<!-- Date Picker -->
	<script src="js/bootstrap-datepicker.js"></script>
	<!-- Stellar Parallax -->
	<script src="js/jquery.stellar.min.js"></script>
	<!-- Main -->
	<script src="js/main.js"></script>

	<%-include('include/foot')-%>